<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="icon"
      type="image/png"
      href="{{ url_for('static', filename='images/logos/favicon-48x48.png') }}"
      sizes="48x48"
    />
    <link
      rel="icon"
      type="image/svg+xml"
      href="{{ url_for('static', filename='images/logos/favicon.svg') }}"
    />
    <link
      rel="shortcut icon"
      href="{{ url_for('static', filename='images/logos/favicon.ico') }}"
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="{{ url_for('static', filename='images/logos/apple-touch-icon.png') }}"
    />
    <meta name="apple-mobile-web-app-title" content="Podly" />
    <link
      rel="manifest"
      href="{{ url_for('static', filename='site.webmanifest') }}"
    />
    <title>Podly</title>
  </head>
  <body>
    <div style="text-align: center">
      <img
        src="{{ url_for('static', filename='images/logos/logo_with_text.png') }}"
        alt="Podly Logo"
        style="width: 500px"
      />
    </div>
    <p align="center">Ad-block for podcasts. Create an ad-free RSS feed.</p>

    <div style="width: 500px; margin: 0 auto">
      <h2>Usage</h2>
      <ul>
        <li>Add an rss feed using the "Add New Feed" box below</li>
        <li>
          Subscribe to the podly RSS feed
          <ul>
            <li>for example http://localhost:5001/feed/1</li>
          </ul>
        </li>
        <li>
          Open a podcast app & subscribe to the podcast using the podly URL
          whose link was added below. For example
          <code>http://myserver:5001/feed/1</code>
        </li>

        <li>Select an episode & download</li>
        <li>
          Wait patiently. Transcription is the slowest part & takes about 1
          minute per 15 minutes of podcast on an M3 MacBook.
        </li>
      </ul>
    </div>
    <div style="width: 500px; margin: 0 auto">
      <h2>Add New Feed</h2>
      <form method="post" action="{{ url_for('main.add_feed') }}">
        <label for="feed_url">Feed URL:</label>
        <input type="text" id="feed_url" name="url" required />
        <button type="submit">Add Feed</button>
      </form>
    </div>
    <div style="width: 500px; margin: 0 auto">
      <h2>Feeds</h2>
      {% for feed in feeds %}
      <details id="details-{{feed.id}}">
        <summary>
          <a href="{{ url_for('main.get_feed', f_id=feed.id) }}"
            >{{ feed.title }}</a
          >
          <button id="refresh-button" onclick="refresh('{{feed.id}}')">
            Refresh
          </button>
        </summary>
        <table>
          <thead>
            <tr>
              <th>Title</th>
              <th>Download</th>
              <th>Whitelisted</th>
            </tr>
          </thead>
          <tbody>
            {% for post in feed.posts %}
            <tr>
              <td>{{ post.title }}</td>
              <td>
                <a href="{{ url_for('main.download_post', p_guid=post.guid) }}"
                  >Download</a
                >
              </td>

              <td>
                <input
                  type="checkbox"
                  {%
                  if
                  post.whitelisted
                  %}checked{%
                  endif
                  %}
                  onclick="setWhitelist('{{ post.guid }}', {{ post.whitelisted | lower }})"
                />
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="2">No posts available.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </details>
      {% else %}
      <p>No feeds available.</p>
      {% endfor %}
    </div>

    <script>
      function setWhitelist(postGuid, old_val) {
        console.log("set whitelist for post: " + postGuid + " to: " + !old_val);
        const url = "{{ url_for('main.set_whitelist', p_guid='0', val=False)}}"
          .replace("0", postGuid)
          .replace("/False", "/" + !old_val);
        fetch(url)
          .then((_) => window.location.reload())
          .catch((error) => console.error("Error:", error));
      }
      function refresh(feedId) {
        fetch("{{ url_for('main.get_feed', f_id='0')}}" + feedId)
          .then((_) => window.location.reload())
          .catch((error) => console.error("Error:", error));
      }
      document.addEventListener("DOMContentLoaded", function () {
        const detailsList = document.querySelectorAll("details");
        detailsList.forEach(function (details) {
          const id = details.id;
          const isOpen = localStorage.getItem(id) === "true";
          if (isOpen) {
            details.open = true;
          }

          details.addEventListener("toggle", function () {
            console.log("toggling details: " + id);
            localStorage.setItem(id, details.open);
          });
        });
      });
      window.addEventListener("load", function () {
        // Restore scroll position
        const scrollPosition = localStorage.getItem("scrollPosition");
        console.log("restoring scroll position: " + scrollPosition);
        if (scrollPosition !== null) {
          window.scrollTo(0, parseInt(scrollPosition));
        }
      });
      window.addEventListener("beforeunload", function () {
        // Save scroll position
        console.log("saving scroll position: " + window.scrollY);
        localStorage.setItem("scrollPosition", window.scrollY);
      });
    </script>
  </body>
</html>
